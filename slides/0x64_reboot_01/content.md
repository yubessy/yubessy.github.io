<!-- $theme: gaia -->

## Distributed Deep Newral Network

##### 0x64ç‰©èª ç¬¬08å¤œ "Network"

##### Shotaro Tanaka (@yubessy)

---

### Excuse

* ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã‹ã‘ãŸ
  ã¨æ€ã‚ã›ã¦
* åˆ†æ•£æ©Ÿæ¢°å­¦ç¿’ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’
  çœŸé¢ç›®ã«èªã‚‹ã¤ã‚‚ã‚Šã ã£ãŸã‘ã©
* æ›¸ã„ã¦ã¿ãŸã‚‰ã‚ã¾ã‚Šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è©±ãŒãªã‹ã£ãŸ

~~ãªã‚“ã‹ã”ã‚ã‚“~~

---

### Why Distributed?

* ãƒ‡ãƒ¼ã‚¿é‡ã®å¢—åŠ 
  * ãƒ†ã‚­ã‚¹ãƒˆ < ç”»åƒ < å‹•ç”»
* è¨ˆç®—é‡ã®å¢—åŠ 
  * ã„ã‚ã‚†ã‚‹ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°
* 1ã¤ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®å‡¦ç†ã®é ­æ‰“ã¡

-> æ™‚ä»£ã¯åˆ†æ•£ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

---

### Why Network?

* åˆ†æ•£ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  * = è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ãŒã²ã¨ã¤ã®ç›®çš„ã®è¨ˆç®—ã‚’è¡Œã†
* ãŸã„ã¦ã„ãƒãƒ¼ãƒ‰é–“ã®é€šä¿¡ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯
* ä½•ã‚’ãƒ»ã©ã†åˆ†æ•£ã•ã›ã‚‹ã‹ã‚’è€ƒãˆã‚‹å¿…è¦

-> ãŸã¶ã‚“ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒé‡è¦

---

### åˆ†æ•£å‡¦ç†ã®æ‰ãˆæ–¹

* **åˆ†æ•£å¯¾è±¡**: ä½•ã‚’åˆ†ã‘ã‚‹ã‹
  * ãã‚‚ãã‚‚åˆ†å‰²ã§ãã‚‹ã®ã‹
  * è² è·ã‚’å‡ç­‰ã§ãã‚‹ã‹
* **ãƒãƒ¼ãƒ‰é–“é€šä¿¡**: ã©ã†ã¤ãªãã‹
  * ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒå‹ / ãƒ¯ãƒ¼ã‚«ãƒ¼é–“é€šä¿¡
  * åŒæœŸ / éåŒæœŸ
  * ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ / ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
  * ãƒ—ãƒ­ãƒˆã‚³ãƒ«

---

### æ·±å±¤ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆ (DNN)

* ãŸãã•ã‚“ã®ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã‹ã‚‰ãªã‚‹ã‚°ãƒ©ãƒ•
* ãƒãƒƒã‚¯ãƒ»ãƒ—ãƒ­ãƒ‘ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  * å…¥åŠ›å€¤ã«å¯¾ã™ã‚‹ã€ã‚°ãƒ©ãƒ•ã®å‡ºåŠ›å€¤ã¨æ­£è§£å€¤ã®
    å·®åˆ†ã‚’æ±‚ã‚ã‚‹
  * å·®åˆ†ãŒå°ã•ããªã‚‹ã‚ˆã†ã€å‡ºåŠ›å´ã‹ã‚‰é †ã«
    å„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´
* SGD
  * ãƒ‡ãƒ¼ã‚¿ç‚¹ã‚’ï¼‘å€‹ä¸ãˆã‚‹ã”ã¨ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°

---



---

### DNNã¨åˆ†æ•£å‡¦ç†

* DNNã¯å®Ÿã¯åˆ†æ•£å‡¦ç†ã«å‘ã„ã¦ã„ã‚‹
  * ãƒ¢ãƒ‡ãƒ«ä¸¦åˆ—åŒ– -> ã‚°ãƒ©ãƒ•ã‚’è¤‡æ•°ã®éƒ¨åˆ†ã«åˆ†å‰²
  * ãƒ‡ãƒ¼ã‚¿ä¸¦åˆ—åŒ– -> SGDã‚’ä¸¦åˆ—åŒ–
* "Large Scale Distributed Deep Networks" 
  Dean, et al. 2012.
  * Google ã®è«–æ–‡
  * DNNã®ãƒ¢ãƒ‡ãƒ« / ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£ã«ã¤ã„ã¦è§£èª¬
  * ~~ã¾ãŸãŠå‰ã‹~~

---

### DistBelief: ãƒ¢ãƒ‡ãƒ«ä¸¦åˆ—åŒ–

* åˆ†æ•£å¯¾è±¡: ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆã®ã‚°ãƒ©ãƒ•
    * ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆã‚’éƒ¨åˆ†ã‚°ãƒ©ãƒ•ã«åˆ†å‰²
    * å„éƒ¨åˆ†ã‚°ãƒ©ãƒ•ã‚’åˆ¥ã®ãƒã‚·ãƒ³ã§å‹•ã‹ã™
* ãƒãƒ¼ãƒ‰é–“é€šä¿¡: ãƒ¯ãƒ¼ã‚«ãƒ¼é–“ã®ç›´æ¥é€šä¿¡
    * ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆã®çµåˆéƒ¨ãŒé€šä¿¡

---

### DownpourSGD: ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£

* åˆ†æ•£å¯¾è±¡: å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®é›†åˆ
  * ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
  * å„ãƒãƒ£ãƒ³ã‚¯ã‚’åˆ¥ã®ãƒã‚·ãƒ³ã«å‡¦ç†ã•ã›ã‚‹
* ãƒãƒ¼ãƒ‰é–“é€šä¿¡: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ»ã‚µãƒ¼ãƒæ–¹å¼
  * å„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¿æŒã™ã‚‹ã‚µãƒ¼ãƒ
  * ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰ã¯ä¸€å®šé‡ã®å­¦ç¿’ã‚’çµ‚ãˆã‚‹ã”ã¨ã«
    éåŒæœŸé€šä¿¡ã«ã‚ˆã‚Šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°

---

### ã“ã‚ŒGç¤¾ä»¥å¤–æ‰±ãˆã‚‹ã®ï¼Ÿ

##### ã¨æ€ã£ãŸã‚ãªãŸã¸

---

### Distributed TensorFlow

* ã“ã“ã¾ã§èª¬æ˜ã—ãŸåˆ†æ•£å‡¦ç†æ©Ÿèƒ½ãŒ
  å®Ÿã¯ã™ã§ã« TensorFlow ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹
* ğŸ” Distributed TensorFlow

TODO: å›³

---

### ã‚¯ãƒ©ã‚¹ã‚¿å®šç¾©

```python
cluster = tf.train.ClusterSpec({
    "worker": [  # ãƒ‡ãƒ¼ã‚¿åˆ†æ•£ã®ãŸã‚ã®ãƒ¯ãƒ¼ã‚«ãƒ¼
        "worker0.example.com:2222", 
        "worker1.example.com:2222",
        "worker2.example.com:2222"
    ],
    "ps": [  # ãƒ¢ãƒ‡ãƒ«åˆ†æ•£ã®ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ
        "ps0.example.com:2222",
        "ps1.example.com:2222"
    ]})
```

---

### ãƒ¢ãƒ‡ãƒ«ä¸¦åˆ—åŒ–

* ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆã®å„å±¤ã‚’è¤‡æ•°ã®PSã«åˆ†æ•£

```python
with tf.device("/job:ps/task:0"):
  weights_1 = tf.Variable(...)
  biases_1 = tf.Variable(...)
 
with tf.device("/job:ps/task:1"):
  weights_2 = tf.Variable(...)
  biases_2 = tf.Variable(...)
```

---

### ãƒ‡ãƒ¼ã‚¿ä¸¦åˆ—åŒ–

* å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ•£ã•ã›ã€ãƒ¢ãƒ‡ãƒ«ã®ã‚°ãƒ©ãƒ•ã‚’å®šç¾©

```python
dev = tf.train.replica_device_setter(
    worker_device="/job:worker/task:%d" % FLAGS.task_index,
    cluster=cluster)

with tf.device(dev):
    input, labels = ...
    layer_1 = tf.nn.relu(tf.matmul(input, weights_1) + biases_1)
    logits = tf.nn.relu(tf.matmul(layer_1, weights_2) + biases_2)
    train_op = ...
```

---

### å­¦ç¿’

* å„ãƒ¯ãƒ¼ã‚«ã§å­¦ç¿’ã‚’å®Ÿè¡Œ

```
with tf.train.MonitoredTrainingSession(
    master=server.target, is_chief=(FLAGS.task_index == 0)) as sess:
    while not sess.should_stop():
        mon_sess.run(train_op)
```

---   

### ã¾ã¨ã‚

---

### å‚è€ƒ

* [Large Scale Distributed Deep Networks](http://www.cs.toronto.edu/~ranzato/publications/DistBeliefNIPS2012_withAppendix.pdf)
* [Distributed TensorFlow](https://www.tensorflow.org/deploy/distributed)
* [Distributed TensorFlowã‚’è©¦ã—ã¦ã¿ã‚‹](http://qiita.com/ashitani/items/2e48729e78a9f77f9790)
* [Distributed TensorFlowã®è©±](http://qiita.com/kazunori279/items/981a8a2a44f5d1172856)
